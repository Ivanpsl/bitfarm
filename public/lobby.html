<!DOCTYPE html>
<html lang="es">
<head>
    <title>FarmChain</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <!-- Bootstrap css-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- bootstrap javascript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js" integrity="sha384-DkkWv9oJFWLIydBXXjkBWnG1/fuVhw8YPBq37uvvD6WSYRFRqr21eY5Dg9ZhmWdy" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./stylesheets/game.css">

   <!-- <script src='./js/socketManager.js'></script> -->
   <!-- <script src='./js/lobbyManager.js'></script> -->
   <script type="text/javascript">

        var ioServerURL = "http://localhost:3001";
        var socketio;
        var gameRooms = [];
        var players = [];
        var selectedRoomId;
        var refreshing = false;
        function toast(toastId,message,title){
            
            var dt = new Date();
            document.getElementById("datetime-"+toastId).innerHTML = dt.toLocaleTimeString();
            document.getElementById("toast-body-"+toastId).innerHTML = message;
            document.getElementById("me-auto-"+toastId).innerHTML = title;

            $('.'+toastId).toast();
            $('.'+toastId).toast('show');
        }

        function initWebSocket(){
                // myToastEl.show();
                
            if(!window.WebSocket){
                // displayMessage("Tu navegador no soporta WebSockets");
                return;
            }

            socketio = io.connect(ioServerURL, { 'forceNew': true, query :'name='+document.cookie? document.cookie:"uknown"});
            socketio.on('connect', function(data) {
                toast("toastConnect","Se ha conectado con los servidores.\n <p class=\"fw-bold\">ID: "+socketio.id+"</p>","Conexion establecida")
            });
            socketio.on("disconnect", function(reason) {
                //    displayMessage("[ServerWebSocketIO] Conexion cerrada: ("+reason+")");
                toast("toastError","Se ha perdido la conexión con el servidor: \n---->>> "+reason,"Se ha perdido la conexión con el servidor")

                if (reason === "io server disconnect") {
                        socket.connect();
                    }                  
                    
                });
            socketio.on('error', function(data) {
                    toast("toastError","Error: \n---->>> "+data,"Se ha producido un error")
            });

            socketio.on("update-room-list", (roomList)=> updateRoomList(roomList));
        
        }
        
        function selectItem(index){
            var docRooms = document.getElementsByClassName("room");
            var joinBtn = document.getElementById("joinbtn");
            for(let i = docRooms.length -1; i>=0; i--){
                docRooms[i].classList.remove("selected");
            }

            if(index !== selectedRoomId){
                docRooms[index].classList.add("selected");
                selectedRoomId = index;
                document.getElementById("joinbtn").disabled = false;
            }else{
                selectedRoomId = null;
                document.getElementById("joinbtn").disabled = true;

            }
                         
        }

        function updateRoomList(rooms){
            gameRooms = [];
            var roomList = document.getElementById('rooms');
            removeAllChildNodes(roomList);
            if(rooms.length>0){
                for(let i = 0; i<= rooms.length-1; i++){
                    var container = document.createElement("div");
                    container.className = "room shadow-lg m-1 mx-0 p-0 pb-0";
                    container.addEventListener("click",()=>selectItem(i));
                    var container2 = document.createElement("div");
                    container2.className = "row title-sector p-2 m-1 align-items-center";
                    var roomTitle = document.createElement("div");
                    roomTitle.className="roomtitle col-auto"
                    roomTitle.innerHTML = "Sala: " + rooms[i].roomId;
                    var roomStatus = document.createElement("div");
                    roomStatus.className = "roomstatus col-auto shadow ms-auto text-truncate " + rooms[i].roomStatus
                    roomStatus.innerHTML ="" + getStatusName(rooms[i].roomStatus);
                    
                    container2.appendChild(roomTitle);
                    container2.appendChild(roomStatus);
                    container.appendChild(container2);
                    roomList.appendChild(container);
                }
            }
            document.getElementById("update-icon").classList.remove("nodisplay")
            document.getElementById("update-spin").classList.add("nodisplay");
        }

        function removeAllChildNodes(parent) {
            while (parent && parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }
        function requestUpdate(){
            document.getElementById("update-icon").classList.add("nodisplay")
            document.getElementById("update-spin").classList.remove("nodisplay");
            socketio.emit('request-room-list')
            if(refreshing===false){
                setTimeout(function(){ requestUpdate(); }, 10000);
                refreshing = true;
            }
        }

        function getStatusName(status){
            if(status==="waiting") return "Esperando";
            if(status==="running") return "Jugando";
            if(status==="empty") return "Vacia";
            if(status==="starting") return "Iniciando";
        }

        $( document ).ready(function() {
            toast("toastConnecting","Conectando con el servidor para obtener la lista de partidas.","Conectando con el servidor")
            document.getElementById("joinbtn").disabled = true;
            document.getElementById("update-spin").classList.add("nodisplay");
            requestUpdate();
        });
    </script>
</head>
<body onload="initWebSocket();">
    <div id ="wrapper"  class="container-fluid">
        <div id="gamecontainer" class="content">

            <div id="lobbyscreen" class="row bg rounded-3 col-5 p-3 align-items-center">

                <div class="game-title">
                   <span class="title-text">Farm<span class="title-text2 w-10">Chain</span></span>
                </div>

                <div id="options" class="mb-3 mt-5 pt-3 align-content-center">
                   <button class="btn btn-outline-primary col-md-4 col-sm-7 m-sm-1" onclick= "openLobby();">Unirse a partida privada</button>
                   <button class="btn btn-outline-secondary col-4 m-3 m-sm-1" onclick= "privateMatch();">Volver atras</button>
                </div>

                <div id="rooms" class="">
                    <div class="room shadow-lg m-1 mx-0 p-0 pb-0" onclick="selectItem(0)">
                        <div class="row title-sector p-2 m-1 align-items-center">
                            <!-- <div class="roomtitle col-6"></div> -->
                            <div class="roomtitle col-auto">Titulo de la partida</div>
                            <!-- <div class="col-6"></div> -->
                            <div class="roomstatus col-auto shadow ms-auto text-truncate waiting">Esperando</div>
                            <!-- <button class="btn btn-outline-success p-0 px-3 mx-3 col-auto ms-auto">Unirse</button> -->
                        </div>
                    </div>
                  
                    
                </div>
                <div id="join" class="d-flex mt-1">
                    
                    <imput class="btn col-auto update-btn" id="update-btn" onclick= "requestUpdate();">
                        <span id="update-icon" class="icon bi bi-arrow-repeat"></span>
                        <span id="update-spin" class="spinner-border spinner-border-sm" disabled = "true"></span>
                    </imput>
                    <button class="btn btn-primary col-2 ms-auto m-0 joinbtn" id="joinbtn" onclick= "joinPrivate();">Unirse</button>       
                </div>

                
         

            <!-- <div id="loadingscreen" class="gamelayer">
                <div id="loadingmessage"></div>
            </div>

            <div id="lobbyscreen" class="gamelayer">
                <table id="gameslist"></table>
                <input type="button" id="join" onclick="multiplayer.join();">
                <input type="button" id="cancel" onclick="multiplayer.cancel();">
            </div> -->


<!--
            <div id= "logs" class="">
                <div id="chat" class="chat">
                    <p>
                        <input type="text" placeholder="Consola" size="40" id = "message">
                        <input type="button" value="Enviar" id="sendmessage" onclick="sendMessage()" disabled="true">
                    </p>
                    <p>
                        <textarea rows="10" cols="80" id="display" readonly></textarea>
                    </p>
                </div>
            </div> -->
           
    
     
        </div>
    </div>
    <div class="toast-container">
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
        <div id="liveToast" class="toastConnecting toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <div class="rounded me-2" style="height: 16px;width: 16px;background-color: orange;"></div>
            <strong class="me-auto" id="me-auto-toastConnecting"> Conectando con los servidores</strong>
            <small id="datetime-toastConnecting">11 mins ago</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body" id="toast-body-toastConnecting">
            Conectando con los servidores para obtener la lista de partidas.
          </div>
        </div>
        
        <div id="liveToastConn" class="toastConnect toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
              <div class="rounded me-2" style="height: 16px;width: 16px;background-color: green;"></div>
              <strong class="me-auto" id="me-auto-toastConnect"> Conexión establecida</strong>
              <small id="datetime-toastConnect">11 mins ago</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"  id="toast-body-toastConnect">
              Se ha conectado con los servidores del juego.
            </div>
          </div>

          <div id="liveToast" class="toastError toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
              <div class="rounded me-2" style="height: 16px;width: 16px;background-color: rgb(255, 0, 0);"></div>
              <strong class="me-auto" id="me-auto-toastError"> Conectando con los servidores</strong>
              <small id="datetime-toastError">11 mins ago</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"  id="toast-body-toastError">
              Conectando con los servidores para obtener la lista de partidas.
            </div>
          </div>

        </div>
    </div>
</body>

</html>